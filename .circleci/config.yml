version: 2
jobs:

  # Build and unit test the eu executable
  build:
    docker:
      - image: curvelogic/docker-circleci-haskell
    steps:
      - checkout

      - restore_cache:
          keys:
            - cache-{{ checksum "package.yaml" }}-{{ checksum "stack.yaml" }}
            - cache-{{ checksum "package.yaml" }}-

      - run: stack setup

      - run:
          name: Update PATH to allow stack-built tools
          command: |
            echo 'export PATH=$(stack path --local-bin):$PATH' >> /tmp/env.sh
            echo 'export STACK_DIST_DIR=$(stack path --dist-dir)' >> /tmp/env.sh
            echo 'export STACK_LOCAL_HPC_ROOT=$(stack path --local-hpc-root)' >> /tmp/env.sh

      - run:
          name: Install HLint
          command: stack install hlint

      - run:
          name: Pull dependencies and build
          command: stack build --fast --pedantic --no-terminal --test --no-run-tests

      - save_cache:
          paths:
            - ~/.stack
          key: cache-{{ checksum "package.yaml" }}-{{ checksum "stack.yaml" }}

      - run:
          name: Build, run unit tests with coverage
          command: stack build --fast --test --no-terminal --coverage

      - run:
          name: Run HLint
          command: |
            source /tmp/env.sh
            hlint .

      - run:
          name: Build with no coverage instrumentation
          command: stack build --no-terminal --ghc-options="-O2"

      - persist_to_workspace:
          root: .stack-work
          paths:
            - dist

      - run:
          name: Prepare artifacts
          command: |
            mkdir -p /tmp/artifacts
            source /tmp.env.sh
            cp -R $STACK_DIST_DIR /tmp/artifacts/dist
            cp -R $STACK_LOCAL_HPC_ROOT /tmp/artifacts/coverage

      - store_artifacts:
          path: /tmp/artifacts

  # Test against the eucalypt test suite
  acceptance:

    machine: true

    steps:
      - attach_workspace:
          at: .stack-work
      - run: docker login -u $DOCKER_USER -p $DOCKER_PASS
      - run: docker run -v .stack-work:/tmp/workspace -e EXECUTABLE=/tmp/workspace/dist/x86_64-linux/Cabal-2.0.1.0/eu curvelogic/eucalypt-test-harness:latest

workflows:
  version: 2
  build-workflow:
    jobs:
      - build:
          context: curvelogic-docker-hub
      - acceptance:
          context: curvelogic-docker-hub
          requires:
            - build
