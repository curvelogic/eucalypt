<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>DCE Inside Blocks — Design - eucalypt</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "DCE Inside Blocks \u2014 Design";
        var mkdocs_page_input_path = "plans/2026-02-05-dce-inside-blocks-design.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../.." class="icon icon-home"> eucalypt
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../getting-started/">Getting Started</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../syntax/">Syntax</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../syntax-gotchas/">Syntax Gotchas</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../operators-and-identifiers/">Operators and Identifiers</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../anaphora-and-lambdas/">Anaphora and Lambdas</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../command-line/">Command Line</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../imports/">Imports</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../yaml-embedding/">YAML Embedding</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../prelude/">Prelude Reference</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../tester/">Testing</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Implementation</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../implementation/">Overview</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../architecture/">Architecture</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../gc-implementation/">GC Implementation</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../gc-benchmarking/">GC Benchmarking</a>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../philosophy-lang/">Philosophy</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../..">eucalypt</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../.." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">DCE Inside Blocks — Design</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/curvelogic/eucalypt/edit/master/docs/plans/2026-02-05-dce-inside-blocks-design.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="dce-inside-blocks-design">DCE Inside Blocks — Design</h1>
<h2 id="problem">Problem</h2>
<p>Dead code elimination currently marks ALL block members as reachable. For
namespace-style blocks like <code>str</code> and <code>cal</code>, this means every function is
retained even when only a few are used. This bloats the compiled program.</p>
<h2 id="solution">Solution</h2>
<p>Static-access DCE — track which block members are accessed via static dot
syntax (<code>ns.member</code>) and eliminate unreferenced members when only static
access patterns are used.</p>
<h2 id="key-properties">Key Properties</h2>
<ul>
<li><strong>Conservative</strong> — only eliminate when provably safe</li>
<li><strong>Static access only</strong> — <code>ns.member</code> patterns, not dynamic <code>lookup</code></li>
<li><strong>Namespace focus</strong> — greatest benefit for prelude-style blocks</li>
<li><strong>Opt-out available</strong> — <code>--no-dce</code> flag for debugging</li>
<li><strong>No new errors</strong> — purely an optimisation, same semantics</li>
</ul>
<h2 id="syntax-examples">Syntax Examples</h2>
<pre><code class="language-eu"># Before DCE: both `used` and `unused` retained
ns: { used: 42, unused: 99 }
result: ns.used

# After DCE: only `used` retained
ns: { used: 42 }
result: ns.used
</code></pre>
<h2 id="safe-vs-unsafe-patterns">Safe vs Unsafe Patterns</h2>
<p><strong>Safe patterns (DCE applies):</strong></p>
<table>
<thead>
<tr>
<th>Pattern</th>
<th>Example</th>
<th>Reasoning</th>
</tr>
</thead>
<tbody>
<tr>
<td>Static dot access</td>
<td><code>ns.member</code></td>
<td>Known member at compile time</td>
</tr>
<tr>
<td>Chained access</td>
<td><code>ns.foo.bar</code></td>
<td>Still statically resolvable</td>
</tr>
<tr>
<td>Binding</td>
<td><code>let x: ns.member</code></td>
<td>Static access in binding</td>
</tr>
</tbody>
</table>
<p><strong>Unsafe patterns (preserve all members):</strong></p>
<table>
<thead>
<tr>
<th>Pattern</th>
<th>Example</th>
<th>Reasoning</th>
</tr>
</thead>
<tbody>
<tr>
<td>Dynamic lookup</td>
<td><code>ns lookup(key)</code></td>
<td>Key unknown at compile time</td>
</tr>
<tr>
<td>Iteration</td>
<td><code>ns elements</code></td>
<td>All members potentially accessed</td>
</tr>
<tr>
<td>Merge</td>
<td><code>ns merge(other)</code></td>
<td>Block structure modified</td>
</tr>
<tr>
<td>Passed as argument</td>
<td><code>f(ns)</code></td>
<td>Unknown usage in callee</td>
</tr>
<tr>
<td>Block as value</td>
<td><code>ns</code> alone</td>
<td>Entire block escapes</td>
</tr>
</tbody>
</table>
<h2 id="implementation">Implementation</h2>
<p><strong>Location</strong>: Extend <code>src/core/simplify/prune.rs</code></p>
<p><strong>New component</strong>: <code>BlockAccessTracker</code></p>
<pre><code class="language-rust">struct BlockAccessTracker {
    /// Blocks that have ONLY static access patterns
    static_only: HashSet&lt;LocalId&gt;,
    /// For static-only blocks: which members are accessed
    accessed_members: HashMap&lt;LocalId, HashSet&lt;String&gt;&gt;,
    // Note: uses String keys (pre-interning identifiers in the core
    // AST). SymbolId is a runtime/VM concept; DCE runs at compile time
    // before symbols are interned.
}
</code></pre>
<p><strong>Algorithm</strong>:</p>
<ol>
<li><strong>First pass</strong>: Identify blocks and track access patterns</li>
<li>Mark block as "static-only" initially</li>
<li>On <code>block.member</code> access: record member in <code>accessed_members</code></li>
<li>
<p>On dynamic access: remove block from <code>static_only</code> set</p>
</li>
<li>
<p><strong>Second pass</strong>: Mark reachability</p>
</li>
<li>For static-only blocks: only mark accessed members as reachable</li>
<li>For other blocks: mark all members reachable (current behaviour)</li>
</ol>
<p><strong>Integration with existing DCE</strong>:</p>
<p>The current <code>prune.rs</code> has <code>mark_block_reachable</code> which marks ALL members.
Add a check:</p>
<pre><code class="language-rust">fn mark_block_reachable(&amp;mut self, block_id: LocalId) {
    if self.tracker.is_static_only(block_id) {
        // Only mark accessed members
        for member in self.tracker.accessed_members(block_id) {
            self.mark_reachable(member);
        }
    } else {
        // Current behaviour: mark all members
        for member in block.all_members() {
            self.mark_reachable(member);
        }
    }
}
</code></pre>
<h2 id="edge-cases">Edge Cases</h2>
<p><strong>Nested blocks</strong>: <code>outer.inner.member</code> — track access through the full
chain. If <code>outer</code> is static-only and <code>inner</code> is accessed, then check if
<code>inner</code> is also static-only.</p>
<p><strong>Shadowing</strong>: <code>let ns: other</code> — stop tracking original <code>ns</code> from that
point. The shadowed binding may have different access patterns.</p>
<p><strong>Re-export</strong>: <code>{ x: ns.foo }</code> — <code>foo</code> is marked as used in <code>ns</code>. Other
members of <code>ns</code> can be eliminated if no other access exists.</p>
<h2 id="testing">Testing</h2>
<p><strong>Correctness tests</strong> (harness):
- Programs produce same results with DCE enabled
- Dynamic access patterns preserve all members</p>
<pre><code class="language-eu"># Static access - DCE safe
test-dce-static: { ns: { used: 42, unused: 99 } result: ns.used RESULT: 42 }

# Dynamic access - must preserve all
test-dce-dynamic: {
  ns: { a: 1, b: 2 }
  key: :a
  result: ns lookup(key)
  RESULT: 1
}

# Block escapes - must preserve all
test-dce-escape: {
  ns: { x: 1, y: 2 }
  result: ns elements length
  RESULT: 2
}
</code></pre>
<p><strong>Verification</strong>: Correctness tests plus code review. A <code>--debug-dce</code> flag
can be added later to print eliminated members if needed.</p>
<h2 id="error-handling">Error Handling</h2>
<ul>
<li>No new errors — DCE is purely an optimisation</li>
<li>If analysis is uncertain, default to preserving members (safe fallback)</li>
<li>Feature flag <code>--no-dce</code> disables optimisation for debugging</li>
</ul>
<h2 id="out-of-scope">Out of Scope</h2>
<ul>
<li>DCE for dynamically accessed blocks (would need runtime analysis)</li>
<li>Cross-module DCE (only same compilation unit)</li>
<li>Metrics/statistics collection (avoid performance impact)</li>
<li>Automatic verification of elimination (trust + code review)</li>
</ul>
<h2 id="dependencies">Dependencies</h2>
<p>None — can be implemented independently.</p>
              
            </div>
          </div><footer>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>Copyright (C) 2018-2026 Greg Hawkins</p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/curvelogic/eucalypt" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
    
  </span>
</div>
    <script src="../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../..";</script>
    <script src="../../js/theme_extra.js"></script>
    <script src="../../js/theme.js"></script>
      <script src="../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
